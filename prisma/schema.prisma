// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique // 登入帳號 (ID)
  password  String           // 密碼 (加密後)
  name      String           // 顯示名稱 (Amy, Bob)
  createdAt DateTime @default(now())

  // --- 關聯設定 ---
  
  // 1. 這個人「開」的團 (他是團長)
  createdGroups Group[] @relation("GroupCreator")

  // 2. 這個人「填」的單 (他是參加者)
  orders        GroupOrder[]

  // 3. 朋友關係
  friends   User[]   @relation("UserFriends")
  friendOf  User[]   @relation("UserFriends")
}

// 2. 團購主單 (Group)
model Group {
  id        String   @id @default(uuid())
  title     String   // 團名 (例如: KFC)
  startTime DateTime // 開始時間
  endTime   DateTime // 結束時間
  status    String   @default("OPEN") // 狀態 (OPEN, CLOSED)
  createdAt DateTime @default(now())

  // --- 關聯：團長是誰？ ---
  creatorId String
  creator   User   @relation("GroupCreator", fields: [creatorId], references: [id])

  // --- 關聯：這團有哪些訂單？ ---
  orders    GroupOrder[]

  //  新增關聯：這團的菜單有哪些東西？
  products    GroupMenu[]
}

// 新增：團購可選品項 (這就是菜單！)
model GroupMenu {
  id       String @id @default(uuid())
  name     String // 品項名 (例如: "KFC 蛋塔")
  price    Int    // 設定好的價格 (例如: 35)
  
  // 屬於哪一團的菜單？
  groupId  String
  group    Group  @relation(fields: [groupId], references: [id])

  // --- 對應的訂單項目 ---
  orderItems UserOrder[]
}

// 3. 個人訂單 (GroupOrder) - 連結 人 與 團
model GroupOrder {
  id      String   @id @default(uuid())
  
  // --- 關聯：誰填的？ ---
  userId  String
  user    User     @relation(fields: [userId], references: [id])
  
  // --- 關聯：哪一團？ ---
  groupId String
  group   Group    @relation(fields: [groupId], references: [id])

  // --- 內容：買了什麼？ ---
  items   UserOrder[]
  
  // Pament status: "UNPAID" or "PAID"
  paymentStatus String   @default("UNPAID")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

// 4. 訂單細項 (UserOrder) - 商品內容
model UserOrder {
  id       String @id @default(uuid())
  name     String // 品項名 (Hamburger)
  price    Int    // 單價 (130)
  quantity Int    // 數量 (2)
  
  // --- 關聯：屬於哪張單？ ---
  orderId  String
  order    GroupOrder  @relation(fields: [orderId], references: [id])

  // --- 關聯：對應哪個菜單品項？ (解決價格同步與冗餘問題) ---
  productId String?
  product   GroupMenu? @relation(fields: [productId], references: [id])
}
