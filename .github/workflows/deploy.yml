name: Deploy to EC2

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy iPaidUpay Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          envs: PORT,DATABASE_URL,JWT_SECRET,NODE_ENV,POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB
          script: |
            set -e

            # é©—è­‰ç’°å¢ƒè®Šæ•¸
            echo "PORT=${PORT}"
            echo "NODE_ENV=${NODE_ENV}"
            echo "POSTGRES_USER=${POSTGRES_USER}"

            # é€²å…¥å°ˆæ¡ˆç›®éŒ„
            cd /home/ubuntu/iPaidUpay_Server

            # æ‹‰å–æœ€æ–°ä»£ç¢¼
            git pull origin master

            # å•Ÿå‹•è³‡æ–™åº«
            docker compose up -d postgres

            # ç­‰å¾…è³‡æ–™åº«å°±ç·’
            echo "ç­‰å¾…è³‡æ–™åº«å•Ÿå‹•..."
            sleep 10

            # åŸ·è¡Œè³‡æ–™åº«é·ç§»
            docker compose run --rm server npx prisma migrate deploy

            # é‡æ–°å»ºç½®ä¸¦å•Ÿå‹• server
            docker compose up -d --build --no-deps server

            # ç­‰å¾…æœå‹™å•Ÿå‹•
            echo "ç­‰å¾…æœå‹™å•Ÿå‹•..."
            sleep 15

            # å¥åº·æª¢æŸ¥
            if curl -f http://localhost:3001/api/health 2>/dev/null; then
              echo "âœ… æœå‹™å¥åº·æª¢æŸ¥é€šé"
            else
              echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œé¡¯ç¤ºæ—¥èªŒï¼š"
              docker compose logs --tail=50 server
              exit 1
            fi

            # æ¸…ç†æœªä½¿ç”¨çš„æ˜ åƒ
            docker image prune -f

            echo "ğŸ‰ éƒ¨ç½²å®Œæˆ"

      - name: Deployment Success
        if: success()
        run: echo "âœ… éƒ¨ç½²æˆåŠŸï¼ä¼ºæœå™¨å·²æ›´æ–°"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Actions æ—¥èªŒ"
          exit 1
